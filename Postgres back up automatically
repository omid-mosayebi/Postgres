#!/bin/bash
set -euo pipefail

# === Logging ===
STAMP=$(date +%F)
LOG_FILE="/var/log/db_backup_${STAMP}.log"
exec > >(tee -a "$LOG_FILE") 2>&1

# === Configuration ===
DB="Your database name" #need to be changed
BACKUP_PATH="/home/backups"
HOST="127.0.0.1"
PORT="5432"
USER="USer Name" #need to be changed
REMOTE_HOST="HostName"  #need to be changed
REMOTE_PATH="/mnt/disk1/backups"
REMOTE_USER="root" #need to be changed

# === Environment for cron ===
export PATH="/usr/local/bin:/usr/bin:/bin"
export PGPASSFILE="/root/.pgpass"

# === Ensure backup folder exists ===
mkdir -p "$BACKUP_PATH/$STAMP"

# === Create .pgpass if not exists ===
if [[ ! -f "$PGPASSFILE" ]]; then
  echo "${HOST}:${PORT}:*:${USER}:D7sWFTmz1KmOun1kQ8iJvo/mtwFa7h+2PAUC1ir" > "$PGPASSFILE"  #need to be changed
  chmod 600 "$PGPASSFILE"
fi

# === Perform backup ===
DUMP_FILE="$BACKUP_PATH/$STAMP/${DB}_${STAMP}.dump"
echo "[$(date)] Starting backup of $DB..."

PGOPTIONS='-c statement_timeout=0 -c lock_timeout=0 -c idle_in_transaction_session_timeout=0' \
pg_dump -U "$USER" -h "$HOST" -p "$PORT" -d "$DB" \
  -F c --no-owner --no-privileges \
  --lock-wait-timeout=60000 --jobs=1 \
  -f "$DUMP_FILE" || {
    echo "❌ pg_dump failed at $(date)"
    exit 1
  }

# === Compress backup ===
TAR_FILE="$BACKUP_PATH/databases_${STAMP}.tar.gz"
echo "[$(date)] Compressing backup..."
tar -C "$BACKUP_PATH" -czf "$TAR_FILE" "$STAMP"

# === Upload to remote ===
echo "[$(date)] Uploading to remote backup server with rsync..."
rsync -avz --progress --partial --remove-source-files \
  -e "ssh -o StrictHostKeyChecking=no" \
  "$TAR_FILE" "${REMOTE_USER}@${REMOTE_HOST}:${REMOTE_PATH}/" || {
    echo "❌ Rsync transfer failed at $(date)"
    exit 2
}


# === Optional restore test on remote (skip if not configured) ===
# ssh ${REMOTE_USER}@${REMOTE_HOST} "pg_restore -l ${REMOTE_PATH}/${TAR_FILE} > /dev/null 2>&1 && echo 'Remote restore test OK'"

# === Keep last 7 days only ===
echo "[$(date)] Cleaning old backups..."
find "$BACKUP_PATH" -type d -mtime +7 -exec rm -rf {} \; 2>/dev/null || true

# === Clean local files if desired ===
rm -rf "$BACKUP_PATH/$STAMP"
rm -f "$TAR_FILE"

echo "✅ Backup completed successfully at $(date)"
